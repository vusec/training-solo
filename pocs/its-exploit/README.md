# Indirect Target Selection (ITS) end-to-end exploit

This folder contains an end-to-end exploit for indirect Target Selection (ITS)
vulnerability for user-kernel scenario using cBPF.
It shows how an attacker can place a direct branch at a specific
address in kernel space that 'collides' with a target indirect (victim) branch.

The user program uses cBPF to place a direct branch at a specific offset.
We use the prefetch side-channel to infer if a new cBPF chunk is allocated
and at which location.

The user program massages the cBPF allocation to allocate a cBPF program
at a targeted address. Once the direct branch is placed at a colliding offset,
the speculation of the 'victim branch' in the kernel text will be redirected
to the "spectre gadget" and the attacker can load a secret and encode it in
a shared F+R buffer.

## Tested microarchitectures

The end-to-end exploit is tested on the following Intel CPU:

- Intel(R) Core(TM) i7-10700K CPU @ 3.80GHz (Comet Lake)
- Intel(R) Core(TM) i7-11700 CPU @ 2.50GHz (Rocket Lake)

## Linux Kernel

We tested the PoC with Linux kernel 6.8.0-38-generic (Ubuntu 24.04).
If your distribution is Ubuntu 24 (or if you added the Ubuntu source lists),
you can install the kernel via APT:

```sh
# Kernel image
sudo apt install linux-image-6.8.0-38-generic
# Headers and modules
sudo apt install linux-headers-6.8.0-38-generic linux-modules-6.8.0-38-generic
```

Otherwise, you can download the image and install manually:

```sh
# Kernel image
wget http://archive.ubuntu.com/ubuntu/pool/main/l/linux-signed/linux-image-6.8.0-38-generic_6.8.0-38.38_amd64.deb
# Kernel headers
wget http://nl.archive.ubuntu.com/ubuntu/pool/main/l/linux/linux-headers-6.8.0-38-generic_6.8.0-38.38_amd64.deb
wget http://nl.archive.ubuntu.com/ubuntu/pool/main/l/linux/linux-headers-6.8.0-38_6.8.0-38.38_all.deb
# Kernel modules
wget http://nl.archive.ubuntu.com/ubuntu/pool/main/l/linux/linux-modules-6.8.0-38-generic_6.8.0-38.38_amd64.deb
# You probably need to install other dependencies (it could be easier to
# add the ubuntu sources and install via first approach)
```

## Running the exploit

```sh
Usage:
./run.sh {leak_shadow, leak_dummy, test_rate} [options]
  -p                 Enable the use of proc pagemap (sudo)
```

End-to-end `etc/shadow` leak (adjust ARCH):

```sh
ARCH=INTEL_10_GEN ./run.sh leak_shadow
```

Test the leakage rate (using proc-map for use page finding)

```sh
sudo ARCH=INTEL_10_GEN ./run.sh -p
```

Leak dummy (ABC) secret:

```sh
sudo ARCH=INTEL_10_GEN ./run.sh -p leak_dummy
```

A reference output is provided in `output.ref`. The file `cbpf-colliding-program.asm`
contains the generated assembly code of the inserted cBPF program with
the training direct branch.
