# Training Solo History-based End-to-end Exploit

This folder contains the end-to-end exploit for the Training Solo History-based
attack. It shows how the current Native BHI software mitigations
(Software-BHB clearance) and recent hardware mitigations (BHI_NO) can be
bypassed via cBPF.

The user program crafts a cBPF program for a SECCOMP filter and installs
it in the kernel. We will use the cBPF program to randomize the history
of the victim branch, to force a iBTB collision.
Each iteration, we fist execute the kernel training branch to
inject the address of the disclosure gadget inside the iBTB.
Next we execute the victim branch, while we start randomizing its history
via the cBPF history. When we find an iBTB collision, the victim indirect branch
will misspeculate to the disclosure gadget and we can leak arbitrary memory \()/.

## Tested microarchitectures

The PoC is tested on the following Intel CPUs:

- Intel(R) Core(TM) i7-11700 CPU (Rocket Lake, Cypress Cove)
- Intel(R) Core(TM) Ultra 7 258V CPU (Lunar Lake, Lion Cove)

## Build the kernel

We tested the end-to-end exploit with Linux kernel 6.8.0-38-generic (Ubuntu 24.04).
If your distribution is Ubuntu 24 (or if you added the Ubuntu source lists),
you can install the kernel via APT:

```sh
# Kernel image
sudo apt install linux-image-6.8.0-38-generic
# Headers and modules
sudo apt install linux-headers-6.8.0-38-generic linux-modules-6.8.0-38-generic
```

Otherwise, you can download the image and install manually:

```sh
# Kernel image
wget http://archive.ubuntu.com/ubuntu/pool/main/l/linux-signed/linux-image-6.8.0-38-generic_6.8.0-38.38_amd64.deb
# Kernel headers
wget http://nl.archive.ubuntu.com/ubuntu/pool/main/l/linux/linux-headers-6.8.0-38-generic_6.8.0-38.38_amd64.deb
wget http://nl.archive.ubuntu.com/ubuntu/pool/main/l/linux/linux-headers-6.8.0-38_6.8.0-38.38_all.deb
# Kernel modules
wget http://nl.archive.ubuntu.com/ubuntu/pool/main/l/linux/linux-modules-6.8.0-38-generic_6.8.0-38.38_amd64.deb
# You probably need to install other dependencies (it may be easier to
# add the ubuntu sources and install via first approach)
```

## Running the exploit

``` md
Usage: ./run.sh
  -p                 Enable the use of proc pagemap (sudo)
```

Run the end-to-end exploit (including huge page finding):

``` bash
cd user
sudo ARCH=INTEL_11_GEN ./run.sh
```

Run the exploit (fast-way) (adjust ARCH):

``` bash
cd user
sudo ARCH=INTEL_11_GEN ./run.sh -p
```
