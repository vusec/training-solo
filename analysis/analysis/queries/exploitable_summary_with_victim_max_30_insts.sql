select "9th gen" as "uarch", "cache gadget" as type,
count(DISTINCT (ind_address || dir_address)) as dir_ind_combinations, count(DISTINCT ind_address) as unique_ind_branches, count(DISTINCT dir_address) as unique_dir_branches, count(DISTINCT target) as unique_targets
from gadgets_victims
where exploitable = 'True'
and  CAST(n_victims_name AS INT) > 0 and n_instr <= 30
and base_has_indirect_secret_dependency = 'False'
and tag_match_29$22_21$14 = 'True'
and (target_bit_length == 10 or target_bit_length == 32)

union ALL

select "10th gen" as "uarch", "cache gadget" as type,
count(DISTINCT (ind_address || dir_address)) as dir_ind_combinations, count(DISTINCT ind_address) as unique_ind_branches, count(DISTINCT dir_address) as unique_dir_branches, count(DISTINCT target) as unique_targets
from gadgets_victims
where exploitable = 'True'
and  CAST(n_victims_name AS INT) > 0 and n_instr <= 30
and base_has_indirect_secret_dependency = 'False'
and tag_match_29$22_21$14 = 'True'
and full_match = 'False'
and (target_bit_length == 12 or target_bit_length == 32)


union ALL

select "11th gen" as "uarch", "cache gadget" as type,
count(DISTINCT (ind_address || dir_address)) as dir_ind_combinations, count(DISTINCT ind_address) as unique_ind_branches, count(DISTINCT dir_address) as unique_dir_branches, count(DISTINCT target) as unique_targets
from gadgets_victims
where exploitable = 'True'
and  CAST(n_victims_name AS INT) > 0 and n_instr <= 30
and base_has_indirect_secret_dependency = 'False'
and tag_match_33$24_23$14 = 'True'
and full_match = 'False'
and (target_bit_length == 12 or target_bit_length == 32)

-- TFPS

union ALL

select "9th gen" as "uarch", "tfp" as type,
count(DISTINCT (ind_address || dir_address)) as dir_ind_combinations, count(DISTINCT ind_address) as unique_ind_branches, count(DISTINCT dir_address) as unique_dir_branches, count(DISTINCT target) as unique_targets
from tfps_victims
where contains_spec_stop = 'False'
and tag_match_29$22_21$14 = 'True'
and (target_bit_length == 10 or target_bit_length == 32)
and  CAST(n_victims_name AS INT) > 0 and n_instr <= 30

union ALL

select "10th gen" as "uarch", "tfp" as type,
count(DISTINCT (ind_address || dir_address)) as dir_ind_combinations, count(DISTINCT ind_address) as unique_ind_branches, count(DISTINCT dir_address) as unique_dir_branches, count(DISTINCT target) as unique_targets
from tfps_victims
where contains_spec_stop = 'False'
and tag_match_29$22_21$14 = 'True'
and full_match = 'False'
and (target_bit_length == 12 or target_bit_length == 32)
and  CAST(n_victims_name AS INT) > 0 and n_instr <= 30


union ALL

select "11th gen" as "uarch", "tfp" as type,
count(DISTINCT (ind_address || dir_address)) as dir_ind_combinations, count(DISTINCT ind_address) as unique_ind_branches, count(DISTINCT dir_address) as unique_dir_branches, count(DISTINCT target) as unique_targets
from tfps_victims
where contains_spec_stop = 'False'
and tag_match_33$24_23$14 = 'True'
and full_match = 'False'
and (target_bit_length == 12 or target_bit_length == 32)
and  CAST(n_victims_name AS INT) > 0 and n_instr <= 30

-- Secret dependent branches

union ALL

select "9th gen" as "uarch", "sec. dep. branch" as type,
count(DISTINCT (ind_address || dir_address)) as dir_ind_combinations, count(DISTINCT ind_address) as unique_ind_branches, count(DISTINCT dir_address) as unique_dir_branches, count(DISTINCT target) as unique_targets
from gadgets_victims
where transmitter = "TransmitterType.SECRET_DEP_BRANCH"
and
-- Make sure we have attacker control
 (
	cmp_value_control = "ControlType.CONTROLLED"
		and
		(secret_address_requirements_indirect_regs != cmp_value_requirements_indirect_regs
		or secret_address_requirements_direct_regs != cmp_value_requirements_direct_regs)

	OR
	(
	base_control == "ControlType.CONTROLLED" and
		(base_control_type == "BaseControlType.BASE_INDEPENDENT_FROM_SECRET" or base_control_type == "BaseControlType.COMPLEX_TRANSMISSION")
))
and  CAST(n_victims_name AS INT) > 0 and n_instr <= 30
-- uarch specific
and tag_match_29$22_21$14 = 'True'
and (target_bit_length == 10 or target_bit_length == 32)

union ALL

select "10th gen" as "uarch", "sec. dep. branch" as type,
count(DISTINCT (ind_address || dir_address)) as dir_ind_combinations, count(DISTINCT ind_address) as unique_ind_branches, count(DISTINCT dir_address) as unique_dir_branches, count(DISTINCT target) as unique_targets
from gadgets_victims
where transmitter = "TransmitterType.SECRET_DEP_BRANCH"
and
-- Make sure we have attacker control
 (
	cmp_value_control = "ControlType.CONTROLLED"
		and
		(secret_address_requirements_indirect_regs != cmp_value_requirements_indirect_regs
		or secret_address_requirements_direct_regs != cmp_value_requirements_direct_regs)

	OR
	(
	base_control == "ControlType.CONTROLLED" and
		(base_control_type == "BaseControlType.BASE_INDEPENDENT_FROM_SECRET" or base_control_type == "BaseControlType.COMPLEX_TRANSMISSION")
))
and  CAST(n_victims_name AS INT) > 0 and n_instr <= 30
-- uarch specific
and tag_match_29$22_21$14 = 'True'
and full_match = 'False'
and (target_bit_length == 12 or target_bit_length == 32)

union ALL

select "11th gen" as "uarch", "sec. dep. branch" as type,
count(DISTINCT (ind_address || dir_address)) as dir_ind_combinations, count(DISTINCT ind_address) as unique_ind_branches, count(DISTINCT dir_address) as unique_dir_branches, count(DISTINCT target) as unique_targets
from gadgets_victims
where transmitter = "TransmitterType.SECRET_DEP_BRANCH"
and
-- Make sure we have attacker control
 (
	cmp_value_control = "ControlType.CONTROLLED"
		and
		(secret_address_requirements_indirect_regs != cmp_value_requirements_indirect_regs
		or secret_address_requirements_direct_regs != cmp_value_requirements_direct_regs)

	OR
	(
	base_control == "ControlType.CONTROLLED" and
		(base_control_type == "BaseControlType.BASE_INDEPENDENT_FROM_SECRET" or base_control_type == "BaseControlType.COMPLEX_TRANSMISSION")
))
and  CAST(n_victims_name AS INT) > 0 and n_instr <= 30
-- uarch specific
and tag_match_33$24_23$14 = 'True'
and full_match = 'False'
and (target_bit_length == 12 or target_bit_length == 32)


-------------------------------------------------------------------------------
-- 9th gen all types

UNION ALL

select "9th gen" as "uarch", "all" as type,
count(DISTINCT (ind_address || dir_address)) as dir_ind_combinations, count(DISTINCT ind_address) as unique_ind_branches, count(DISTINCT dir_address) as unique_dir_branches, count(DISTINCT target) as unique_targets
from
(

select dir_address, ind_address, target
from gadgets_victims
where exploitable = 'True'
and  CAST(n_victims_name AS INT) > 0 and n_instr <= 30
and base_has_indirect_secret_dependency = 'False'
and tag_match_29$22_21$14 = 'True'
and (target_bit_length == 10 or target_bit_length == 32)

UNION ALL

select dir_address, ind_address, target
from tfps_victims
where contains_spec_stop = 'False'
and tag_match_29$22_21$14 = 'True'
and (target_bit_length == 10 or target_bit_length == 32)
and  CAST(n_victims_name AS INT) > 0 and n_instr <= 30

UNION ALL

select dir_address, ind_address, target
from gadgets_victims
where transmitter = "TransmitterType.SECRET_DEP_BRANCH"
and
-- Make sure we have attacker control
 (
	cmp_value_control = "ControlType.CONTROLLED"
		and
		(secret_address_requirements_indirect_regs != cmp_value_requirements_indirect_regs
		or secret_address_requirements_direct_regs != cmp_value_requirements_direct_regs)

	OR
	(
	base_control == "ControlType.CONTROLLED" and
		(base_control_type == "BaseControlType.BASE_INDEPENDENT_FROM_SECRET" or base_control_type == "BaseControlType.COMPLEX_TRANSMISSION")
))
and  CAST(n_victims_name AS INT) > 0 and n_instr <= 30
-- uarch specific
and tag_match_29$22_21$14 = 'True'
and (target_bit_length == 10 or target_bit_length == 32)
)


-- 10th gen all types

UNION ALL

select "10th gen" as "uarch", "all" as type,
count(DISTINCT (ind_address || dir_address)) as dir_ind_combinations, count(DISTINCT ind_address) as unique_ind_branches, count(DISTINCT dir_address) as unique_dir_branches, count(DISTINCT target) as unique_targets
from
(

select dir_address, ind_address, target
from gadgets_victims
where exploitable = 'True'
and  CAST(n_victims_name AS INT) > 0 and n_instr <= 30
and base_has_indirect_secret_dependency = 'False'
and tag_match_29$22_21$14 = 'True'
and full_match = 'False'
and (target_bit_length == 12 or target_bit_length == 32)


UNION ALL

select dir_address, ind_address, target
from tfps_victims
where contains_spec_stop = 'False'
and tag_match_29$22_21$14 = 'True'
and full_match = 'False'
and (target_bit_length == 12 or target_bit_length == 32)
and  CAST(n_victims_name AS INT) > 0 and n_instr <= 30


UNION ALL

select dir_address, ind_address, target
from gadgets_victims
where transmitter = "TransmitterType.SECRET_DEP_BRANCH"
and
-- Make sure we have attacker control
 (
	cmp_value_control = "ControlType.CONTROLLED"
		and
		(secret_address_requirements_indirect_regs != cmp_value_requirements_indirect_regs
		or secret_address_requirements_direct_regs != cmp_value_requirements_direct_regs)

	OR
	(
	base_control == "ControlType.CONTROLLED" and
		(base_control_type == "BaseControlType.BASE_INDEPENDENT_FROM_SECRET" or base_control_type == "BaseControlType.COMPLEX_TRANSMISSION")
))
and  CAST(n_victims_name AS INT) > 0 and n_instr <= 30
-- uarch specific
and tag_match_29$22_21$14 = 'True'
and full_match = 'False'
and (target_bit_length == 12 or target_bit_length == 32)
)

-- 11th gen all types

UNION ALL

select "11th gen" as "uarch", "all" as type,
count(DISTINCT (ind_address || dir_address)) as dir_ind_combinations, count(DISTINCT ind_address) as unique_ind_branches, count(DISTINCT dir_address) as unique_dir_branches, count(DISTINCT target) as unique_targets
from
(

select dir_address, ind_address, target
from gadgets_victims
where exploitable = 'True'
and  CAST(n_victims_name AS INT) > 0 and n_instr <= 30
and base_has_indirect_secret_dependency = 'False'
and tag_match_33$24_23$14 = 'True'
and full_match = 'False'
and (target_bit_length == 12 or target_bit_length == 32)


UNION ALL

select dir_address, ind_address, target
from tfps_victims
where contains_spec_stop = 'False'
and tag_match_33$24_23$14 = 'True'
and full_match = 'False'
and (target_bit_length == 12 or target_bit_length == 32)
and  CAST(n_victims_name AS INT) > 0 and n_instr <= 30

UNION ALL

select dir_address, ind_address, target
from gadgets_victims
where transmitter = "TransmitterType.SECRET_DEP_BRANCH"
and
-- Make sure we have attacker control
 (
	cmp_value_control = "ControlType.CONTROLLED"
		and
		(secret_address_requirements_indirect_regs != cmp_value_requirements_indirect_regs
		or secret_address_requirements_direct_regs != cmp_value_requirements_direct_regs)

	OR
	(
	base_control == "ControlType.CONTROLLED" and
		(base_control_type == "BaseControlType.BASE_INDEPENDENT_FROM_SECRET" or base_control_type == "BaseControlType.COMPLEX_TRANSMISSION")
))
and  CAST(n_victims_name AS INT) > 0 and n_instr <= 30
-- uarch specific
and tag_match_33$24_23$14 = 'True'
and full_match = 'False'
and (target_bit_length == 12 or target_bit_length == 32)
)

-- union ALL
--
-- select "full collision" as "uarch", count(*) as exploitable from gadgets_victims
-- where exploitable = 'True'
-- and base_has_indirect_secret_dependency = 'False'
-- and tag_match_29$22_21$14 = 'True'
-- and full_match = 'True'
-- and (target_bit_length == 10 or target_bit_length == 32)
